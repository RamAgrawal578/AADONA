<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AADONA Admin</title>
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
  <style>
    body, html { height: 100%; margin: 0; font-family: system-ui, Arial; }
    header { display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid #eee; }
    #login { max-width: 360px; margin: 80px auto; padding: 24px; border: 1px solid #eee; border-radius: 12px; }
    #gjs { height: calc(100vh - 56px); }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <strong>AADONA Admin</strong>
    <span id="who" style="margin-left:auto; opacity:.7;"></span>
    <button id="btnLogout" class="hidden">Logout</button>
  </header>

  <!-- Login panel -->
  <div id="login">
    <h3>Admin Login</h3>
    <input id="email" type="email" placeholder="Email" style="width:100%;padding:10px;"><br><br>
    <input id="password" type="password" placeholder="Password" style="width:100%;padding:10px;"><br><br>
    <button id="btnLogin" style="width:100%;padding:10px;">Login</button>
    <p style="opacity:.7;margin-top:8px;">Use the admin/staff email you added in Firebase Authentication.</p>
  </div>

  <!-- Editor panel -->
  <div id="editor" class="hidden">
    <div style="padding:8px 14px; border-bottom:1px solid #eee; display:flex; gap:8px;">
      <input type="file" id="imgUpload" accept="image/*" multiple />
      <button id="btnSave">ðŸ’¾ Save</button>
      <span id="status" style="margin-left:auto; opacity:.7;"></span>
    </div>
    <div id="gjs"><!-- Seed content (first-time) -->
      <section class="hero">
        <h1>Welcome to AADONA</h1>
        <p>Edit this text and drag in images. Use the Save button to publish.</p>
        <img src="https://via.placeholder.com/900x400" alt="Hero">
      </section>
    </div>
  </div>

  <script src="https://unpkg.com/grapesjs"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // 1) Your Firebase config (same as index.html)
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      appId: "YOUR_APP_ID"
    };

    // 2) Init Firebase
    const app     = initializeApp(firebaseConfig);
    const auth    = getAuth(app);
    const db      = getFirestore(app);
    const storage = getStorage(app);

    const loginEl  = document.getElementById('login');
    const editorEl = document.getElementById('editor');
    const whoEl    = document.getElementById('who');
    const statusEl = document.getElementById('status');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout= document.getElementById('btnLogout');

    let editor; // GrapesJS instance

    // 3) Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginEl.classList.add('hidden');
        editorEl.classList.remove('hidden');
        btnLogout.classList.remove('hidden');
        whoEl.textContent = user.email || '';
        await bootEditor();
      } else {
        loginEl.classList.remove('hidden');
        editorEl.classList.add('hidden');
        btnLogout.classList.add('hidden');
        whoEl.textContent = '';
        if (editor) editor.destroy();
      }
    });

    // 4) Login / Logout
    btnLogin.onclick = async () => {
      const email = (document.getElementById('email').value || '').trim();
      const pass  = (document.getElementById('password').value || '').trim();
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) { alert(e.message); }
    };
    btnLogout.onclick = async () => { await signOut(auth); };

    // 5) Boot GrapesJS + load saved page if exists
    async function bootEditor() {
      editor = grapesjs.init({
        container: '#gjs',
        fromElement: true,
        height: '100%',
        storageManager: { type: null } // we control saving manually
      });

      // Add simple blocks
      editor.BlockManager.add('text',  { label:'Text',  content:'<p>Text</p>' });
      editor.BlockManager.add('image', { label:'Image', content:'<img src="https://via.placeholder.com/600x300"/>' });

      // Load saved content
      try {
        const snap = await getDoc(doc(db, "pages", "home"));
        if (snap.exists()) {
          const data = snap.data();
          if (data.html) editor.setComponents(data.html);
          if (data.css)  editor.setStyle(data.css);
        }
      } catch (e) {
        console.warn("No saved page yet or error loading:", e);
      }

      // Image uploads â†’ add to Assets so you can drag them in
      const imgInput = document.getElementById('imgUpload');
      imgInput.onchange = async (e) => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        statusEl.textContent = "Uploading imagesâ€¦";
        const urls = [];
        for (const file of files) {
          const p = `uploads/${Date.now()}-${Math.random().toString(36).slice(2)}-${file.name}`;
          const r = ref(storage, p);
          await uploadBytes(r, file);
          const url = await getDownloadURL(r);
          urls.push(url);
          // Push into GrapesJS Asset Manager
          editor.AssetManager.add([{ src: url }]);
        }
        statusEl.textContent = `Uploaded ${urls.length} image(s).`;
        imgInput.value = "";
      };

      // Save button
      document.getElementById('btnSave').onclick = async () => {
        const html = editor.getHtml();
        const css  = editor.getCss();
        statusEl.textContent = "Savingâ€¦";
        try {
          await setDoc(doc(db, "pages", "home"), { html, css, updatedAt: Date.now() });
          statusEl.textContent = "Saved âœ”";
        } catch (e) {
          statusEl.textContent = "Save failed";
          alert(e.message);
        }
      };
    }
  </script>
</body>
</html>
